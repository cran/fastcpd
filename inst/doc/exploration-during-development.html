<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Exploration during development</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Exploration during development</h1>



<div id="exploration-of-the-qmle-method-for-arma-models" class="section level1">
<h1>Exploration of the QMLE method for ARMA models</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>qmle <span class="ot">&lt;-</span> <span class="cf">function</span>(data, theta, <span class="at">p =</span> <span class="dv">1</span>, <span class="at">q =</span> <span class="dv">1</span>) {</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data) <span class="sc">&lt;</span> <span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>) {</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  }</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  variance_term <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>    variance_term[i] <span class="ot">&lt;-</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>      data[i] <span class="sc">-</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>      theta[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)]</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>  }</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>  (<span class="fu">log</span>(<span class="dv">2</span> <span class="sc">*</span> pi) <span class="sc">+</span> <span class="fu">log</span>(theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>])) <span class="sc">*</span> (<span class="fu">nrow</span>(data) <span class="sc">-</span> q) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>    <span class="fu">sum</span>(variance_term<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>}</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>qmle_gradient <span class="ot">&lt;-</span> <span class="cf">function</span>(data, theta, <span class="at">p =</span> <span class="dv">1</span>, <span class="at">q =</span> <span class="dv">1</span>) {</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data) <span class="sc">&lt;</span> <span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>) {</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(theta)))</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  }</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>  variance_term <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>    variance_term[i] <span class="ot">&lt;-</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>      data[i] <span class="sc">-</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>      theta[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)]</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>  }</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>  phi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), p)</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>  psi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), q)</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a>    phi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a>      <span class="sc">-</span>data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> phi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a>  }</span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (q <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a>    psi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a>      <span class="sc">-</span>variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)] <span class="sc">-</span></span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a>  }</span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a>    phi_coefficient[<span class="fu">nrow</span>(data), ] <span class="sc">*</span> variance_term[<span class="fu">nrow</span>(data)] <span class="sc">/</span></span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a>      theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a>    psi_coefficient[<span class="fu">nrow</span>(data), ] <span class="sc">*</span> variance_term[<span class="fu">nrow</span>(data)] <span class="sc">/</span></span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a>      theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a>    <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">-</span></span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a>      variance_term[<span class="fu">nrow</span>(data)]<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a>  )</span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a>}</span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a>qmle_gradient_sum <span class="ot">&lt;-</span> <span class="cf">function</span>(data, theta, <span class="at">p =</span> <span class="dv">1</span>, <span class="at">q =</span> <span class="dv">1</span>) {</span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data) <span class="sc">&lt;</span> <span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>) {</span>
<span id="cb1-49"><a href="#cb1-49" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(theta)))</span>
<span id="cb1-50"><a href="#cb1-50" tabindex="-1"></a>  }</span>
<span id="cb1-51"><a href="#cb1-51" tabindex="-1"></a>  variance_term <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb1-52"><a href="#cb1-52" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-53"><a href="#cb1-53" tabindex="-1"></a>    variance_term[i] <span class="ot">&lt;-</span></span>
<span id="cb1-54"><a href="#cb1-54" tabindex="-1"></a>      data[i] <span class="sc">-</span></span>
<span id="cb1-55"><a href="#cb1-55" tabindex="-1"></a>      theta[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb1-56"><a href="#cb1-56" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)]</span>
<span id="cb1-57"><a href="#cb1-57" tabindex="-1"></a>  }</span>
<span id="cb1-58"><a href="#cb1-58" tabindex="-1"></a>  phi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), p)</span>
<span id="cb1-59"><a href="#cb1-59" tabindex="-1"></a>  psi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), q)</span>
<span id="cb1-60"><a href="#cb1-60" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-61"><a href="#cb1-61" tabindex="-1"></a>    phi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb1-62"><a href="#cb1-62" tabindex="-1"></a>      <span class="sc">-</span>data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb1-63"><a href="#cb1-63" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> phi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb1-64"><a href="#cb1-64" tabindex="-1"></a>  }</span>
<span id="cb1-65"><a href="#cb1-65" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (q <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-66"><a href="#cb1-66" tabindex="-1"></a>    psi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb1-67"><a href="#cb1-67" tabindex="-1"></a>      <span class="sc">-</span>variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)] <span class="sc">-</span></span>
<span id="cb1-68"><a href="#cb1-68" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb1-69"><a href="#cb1-69" tabindex="-1"></a>  }</span>
<span id="cb1-70"><a href="#cb1-70" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb1-71"><a href="#cb1-71" tabindex="-1"></a>    <span class="fu">crossprod</span>(phi_coefficient, variance_term) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb1-72"><a href="#cb1-72" tabindex="-1"></a>    <span class="fu">crossprod</span>(psi_coefficient, variance_term) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb1-73"><a href="#cb1-73" tabindex="-1"></a>    (<span class="fu">nrow</span>(data) <span class="sc">-</span> q) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">-</span></span>
<span id="cb1-74"><a href="#cb1-74" tabindex="-1"></a>      <span class="fu">crossprod</span>(variance_term) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-75"><a href="#cb1-75" tabindex="-1"></a>  )</span>
<span id="cb1-76"><a href="#cb1-76" tabindex="-1"></a>}</span>
<span id="cb1-77"><a href="#cb1-77" tabindex="-1"></a>qmle_hessian <span class="ot">&lt;-</span> <span class="cf">function</span>(data, theta, <span class="at">p =</span> <span class="dv">1</span>, <span class="at">q =</span> <span class="dv">1</span>) {</span>
<span id="cb1-78"><a href="#cb1-78" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data) <span class="sc">&lt;</span> <span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>) {</span>
<span id="cb1-79"><a href="#cb1-79" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">diag</span>(<span class="fu">length</span>(theta)))</span>
<span id="cb1-80"><a href="#cb1-80" tabindex="-1"></a>  }</span>
<span id="cb1-81"><a href="#cb1-81" tabindex="-1"></a>  variance_term <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb1-82"><a href="#cb1-82" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-83"><a href="#cb1-83" tabindex="-1"></a>    variance_term[i] <span class="ot">&lt;-</span></span>
<span id="cb1-84"><a href="#cb1-84" tabindex="-1"></a>      data[i] <span class="sc">-</span></span>
<span id="cb1-85"><a href="#cb1-85" tabindex="-1"></a>      theta[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb1-86"><a href="#cb1-86" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)]</span>
<span id="cb1-87"><a href="#cb1-87" tabindex="-1"></a>  }</span>
<span id="cb1-88"><a href="#cb1-88" tabindex="-1"></a>  phi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), p)</span>
<span id="cb1-89"><a href="#cb1-89" tabindex="-1"></a>  psi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), q)</span>
<span id="cb1-90"><a href="#cb1-90" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-91"><a href="#cb1-91" tabindex="-1"></a>    phi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb1-92"><a href="#cb1-92" tabindex="-1"></a>      <span class="sc">-</span>data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb1-93"><a href="#cb1-93" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> phi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb1-94"><a href="#cb1-94" tabindex="-1"></a>  }</span>
<span id="cb1-95"><a href="#cb1-95" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (q <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-96"><a href="#cb1-96" tabindex="-1"></a>    psi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb1-97"><a href="#cb1-97" tabindex="-1"></a>      <span class="sc">-</span>variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)] <span class="sc">-</span></span>
<span id="cb1-98"><a href="#cb1-98" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb1-99"><a href="#cb1-99" tabindex="-1"></a>  }</span>
<span id="cb1-100"><a href="#cb1-100" tabindex="-1"></a>  phi_psi_coefficient <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">c</span>(q, p, <span class="fu">nrow</span>(data)))</span>
<span id="cb1-101"><a href="#cb1-101" tabindex="-1"></a>  psi_psi_coefficient <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">c</span>(q, q, <span class="fu">nrow</span>(data)))</span>
<span id="cb1-102"><a href="#cb1-102" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (q <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-103"><a href="#cb1-103" tabindex="-1"></a>    phi_psi_coefficient[, , i] <span class="ot">&lt;-</span></span>
<span id="cb1-104"><a href="#cb1-104" tabindex="-1"></a>      <span class="sc">-</span>phi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ] <span class="sc">-</span></span>
<span id="cb1-105"><a href="#cb1-105" tabindex="-1"></a>      <span class="fu">rowSums</span>(</span>
<span id="cb1-106"><a href="#cb1-106" tabindex="-1"></a>        <span class="fu">sweep</span>(</span>
<span id="cb1-107"><a href="#cb1-107" tabindex="-1"></a>          phi_psi_coefficient[, , (i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb1-108"><a href="#cb1-108" tabindex="-1"></a>          <span class="dv">3</span>,</span>
<span id="cb1-109"><a href="#cb1-109" tabindex="-1"></a>          theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)],</span>
<span id="cb1-110"><a href="#cb1-110" tabindex="-1"></a>          <span class="st">`</span><span class="at">*</span><span class="st">`</span></span>
<span id="cb1-111"><a href="#cb1-111" tabindex="-1"></a>        ),</span>
<span id="cb1-112"><a href="#cb1-112" tabindex="-1"></a>        <span class="at">dims =</span> <span class="dv">2</span></span>
<span id="cb1-113"><a href="#cb1-113" tabindex="-1"></a>      )</span>
<span id="cb1-114"><a href="#cb1-114" tabindex="-1"></a>    psi_psi_coefficient[, , i] <span class="ot">&lt;-</span></span>
<span id="cb1-115"><a href="#cb1-115" tabindex="-1"></a>      <span class="sc">-</span>psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ] <span class="sc">-</span></span>
<span id="cb1-116"><a href="#cb1-116" tabindex="-1"></a>      <span class="fu">t</span>(psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]) <span class="sc">-</span></span>
<span id="cb1-117"><a href="#cb1-117" tabindex="-1"></a>      <span class="fu">rowSums</span>(</span>
<span id="cb1-118"><a href="#cb1-118" tabindex="-1"></a>        <span class="fu">sweep</span>(</span>
<span id="cb1-119"><a href="#cb1-119" tabindex="-1"></a>          psi_psi_coefficient[, , (i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb1-120"><a href="#cb1-120" tabindex="-1"></a>          <span class="dv">3</span>,</span>
<span id="cb1-121"><a href="#cb1-121" tabindex="-1"></a>          theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)],</span>
<span id="cb1-122"><a href="#cb1-122" tabindex="-1"></a>          <span class="st">`</span><span class="at">*</span><span class="st">`</span></span>
<span id="cb1-123"><a href="#cb1-123" tabindex="-1"></a>        ),</span>
<span id="cb1-124"><a href="#cb1-124" tabindex="-1"></a>        <span class="at">dims =</span> <span class="dv">2</span></span>
<span id="cb1-125"><a href="#cb1-125" tabindex="-1"></a>      )</span>
<span id="cb1-126"><a href="#cb1-126" tabindex="-1"></a>  }</span>
<span id="cb1-127"><a href="#cb1-127" tabindex="-1"></a>  hessian <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, <span class="at">ncol =</span> p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb1-128"><a href="#cb1-128" tabindex="-1"></a>  hessian[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span></span>
<span id="cb1-129"><a href="#cb1-129" tabindex="-1"></a>    <span class="fu">crossprod</span>(phi_coefficient[<span class="fu">nrow</span>(data), , <span class="at">drop =</span> <span class="cn">FALSE</span>]) <span class="sc">/</span></span>
<span id="cb1-130"><a href="#cb1-130" tabindex="-1"></a>    theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb1-131"><a href="#cb1-131" tabindex="-1"></a>  hessian[<span class="dv">1</span><span class="sc">:</span>p, (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="ot">&lt;-</span> (</span>
<span id="cb1-132"><a href="#cb1-132" tabindex="-1"></a>    <span class="fu">t</span>(phi_psi_coefficient[, , <span class="fu">nrow</span>(data)]) <span class="sc">*</span> variance_term[<span class="fu">nrow</span>(data)] <span class="sc">+</span></span>
<span id="cb1-133"><a href="#cb1-133" tabindex="-1"></a>      <span class="fu">crossprod</span>(</span>
<span id="cb1-134"><a href="#cb1-134" tabindex="-1"></a>        phi_coefficient[<span class="fu">nrow</span>(data), , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb1-135"><a href="#cb1-135" tabindex="-1"></a>        psi_coefficient[<span class="fu">nrow</span>(data), , <span class="at">drop =</span> <span class="cn">FALSE</span>]</span>
<span id="cb1-136"><a href="#cb1-136" tabindex="-1"></a>      )</span>
<span id="cb1-137"><a href="#cb1-137" tabindex="-1"></a>  ) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb1-138"><a href="#cb1-138" tabindex="-1"></a>  hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span> <span class="fu">t</span>(hessian[<span class="dv">1</span><span class="sc">:</span>p, (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)])</span>
<span id="cb1-139"><a href="#cb1-139" tabindex="-1"></a>  hessian[<span class="dv">1</span><span class="sc">:</span>p, p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb1-140"><a href="#cb1-140" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">t</span>(phi_coefficient[<span class="fu">nrow</span>(data), ]) <span class="sc">*</span></span>
<span id="cb1-141"><a href="#cb1-141" tabindex="-1"></a>    variance_term[<span class="fu">nrow</span>(data)] <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-142"><a href="#cb1-142" tabindex="-1"></a>  hessian[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span> <span class="fu">t</span>(hessian[<span class="dv">1</span><span class="sc">:</span>p, p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb1-143"><a href="#cb1-143" tabindex="-1"></a>  hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="ot">&lt;-</span> (</span>
<span id="cb1-144"><a href="#cb1-144" tabindex="-1"></a>    <span class="fu">crossprod</span>(psi_coefficient[<span class="fu">nrow</span>(data), , <span class="at">drop =</span> <span class="cn">FALSE</span>]) <span class="sc">+</span></span>
<span id="cb1-145"><a href="#cb1-145" tabindex="-1"></a>      psi_psi_coefficient[, , <span class="fu">nrow</span>(data)] <span class="sc">*</span> variance_term[<span class="fu">nrow</span>(data)]</span>
<span id="cb1-146"><a href="#cb1-146" tabindex="-1"></a>  ) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb1-147"><a href="#cb1-147" tabindex="-1"></a>  hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb1-148"><a href="#cb1-148" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">t</span>(psi_coefficient[<span class="fu">nrow</span>(data), ]) <span class="sc">*</span></span>
<span id="cb1-149"><a href="#cb1-149" tabindex="-1"></a>    variance_term[<span class="fu">nrow</span>(data)] <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-150"><a href="#cb1-150" tabindex="-1"></a>  hessian[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="ot">&lt;-</span></span>
<span id="cb1-151"><a href="#cb1-151" tabindex="-1"></a>    <span class="fu">t</span>(hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb1-152"><a href="#cb1-152" tabindex="-1"></a>  hessian[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb1-153"><a href="#cb1-153" tabindex="-1"></a>    variance_term[<span class="fu">nrow</span>(data)]<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">3</span> <span class="sc">-</span></span>
<span id="cb1-154"><a href="#cb1-154" tabindex="-1"></a>    <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-155"><a href="#cb1-155" tabindex="-1"></a>  hessian</span>
<span id="cb1-156"><a href="#cb1-156" tabindex="-1"></a>}</span>
<span id="cb1-157"><a href="#cb1-157" tabindex="-1"></a>qmle_hessian_sum <span class="ot">&lt;-</span> <span class="cf">function</span>(data, theta, <span class="at">p =</span> <span class="dv">1</span>, <span class="at">q =</span> <span class="dv">1</span>) {</span>
<span id="cb1-158"><a href="#cb1-158" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data) <span class="sc">&lt;</span> <span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>) {</span>
<span id="cb1-159"><a href="#cb1-159" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">diag</span>(<span class="fu">length</span>(theta)))</span>
<span id="cb1-160"><a href="#cb1-160" tabindex="-1"></a>  }</span>
<span id="cb1-161"><a href="#cb1-161" tabindex="-1"></a>  variance_term <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb1-162"><a href="#cb1-162" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-163"><a href="#cb1-163" tabindex="-1"></a>    variance_term[i] <span class="ot">&lt;-</span></span>
<span id="cb1-164"><a href="#cb1-164" tabindex="-1"></a>      data[i] <span class="sc">-</span></span>
<span id="cb1-165"><a href="#cb1-165" tabindex="-1"></a>      theta[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb1-166"><a href="#cb1-166" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)]</span>
<span id="cb1-167"><a href="#cb1-167" tabindex="-1"></a>  }</span>
<span id="cb1-168"><a href="#cb1-168" tabindex="-1"></a>  phi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), p)</span>
<span id="cb1-169"><a href="#cb1-169" tabindex="-1"></a>  psi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), q)</span>
<span id="cb1-170"><a href="#cb1-170" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-171"><a href="#cb1-171" tabindex="-1"></a>    phi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb1-172"><a href="#cb1-172" tabindex="-1"></a>      <span class="sc">-</span>data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb1-173"><a href="#cb1-173" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> phi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb1-174"><a href="#cb1-174" tabindex="-1"></a>  }</span>
<span id="cb1-175"><a href="#cb1-175" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (q <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-176"><a href="#cb1-176" tabindex="-1"></a>    psi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb1-177"><a href="#cb1-177" tabindex="-1"></a>      <span class="sc">-</span>variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)] <span class="sc">-</span></span>
<span id="cb1-178"><a href="#cb1-178" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb1-179"><a href="#cb1-179" tabindex="-1"></a>  }</span>
<span id="cb1-180"><a href="#cb1-180" tabindex="-1"></a>  phi_psi_coefficient <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">c</span>(q, p, <span class="fu">nrow</span>(data)))</span>
<span id="cb1-181"><a href="#cb1-181" tabindex="-1"></a>  psi_psi_coefficient <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">c</span>(q, q, <span class="fu">nrow</span>(data)))</span>
<span id="cb1-182"><a href="#cb1-182" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (q <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb1-183"><a href="#cb1-183" tabindex="-1"></a>    phi_psi_coefficient[, , i] <span class="ot">&lt;-</span></span>
<span id="cb1-184"><a href="#cb1-184" tabindex="-1"></a>      <span class="sc">-</span>phi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ] <span class="sc">-</span></span>
<span id="cb1-185"><a href="#cb1-185" tabindex="-1"></a>      <span class="fu">rowSums</span>(</span>
<span id="cb1-186"><a href="#cb1-186" tabindex="-1"></a>        <span class="fu">sweep</span>(</span>
<span id="cb1-187"><a href="#cb1-187" tabindex="-1"></a>          phi_psi_coefficient[, , (i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb1-188"><a href="#cb1-188" tabindex="-1"></a>          <span class="dv">3</span>,</span>
<span id="cb1-189"><a href="#cb1-189" tabindex="-1"></a>          theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)],</span>
<span id="cb1-190"><a href="#cb1-190" tabindex="-1"></a>          <span class="st">`</span><span class="at">*</span><span class="st">`</span></span>
<span id="cb1-191"><a href="#cb1-191" tabindex="-1"></a>        ),</span>
<span id="cb1-192"><a href="#cb1-192" tabindex="-1"></a>        <span class="at">dims =</span> <span class="dv">2</span></span>
<span id="cb1-193"><a href="#cb1-193" tabindex="-1"></a>      )</span>
<span id="cb1-194"><a href="#cb1-194" tabindex="-1"></a>    psi_psi_coefficient[, , i] <span class="ot">&lt;-</span></span>
<span id="cb1-195"><a href="#cb1-195" tabindex="-1"></a>      <span class="sc">-</span>psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ] <span class="sc">-</span></span>
<span id="cb1-196"><a href="#cb1-196" tabindex="-1"></a>      <span class="fu">t</span>(psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]) <span class="sc">-</span></span>
<span id="cb1-197"><a href="#cb1-197" tabindex="-1"></a>      <span class="fu">rowSums</span>(</span>
<span id="cb1-198"><a href="#cb1-198" tabindex="-1"></a>        <span class="fu">sweep</span>(</span>
<span id="cb1-199"><a href="#cb1-199" tabindex="-1"></a>          psi_psi_coefficient[, , (i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb1-200"><a href="#cb1-200" tabindex="-1"></a>          <span class="dv">3</span>,</span>
<span id="cb1-201"><a href="#cb1-201" tabindex="-1"></a>          theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)],</span>
<span id="cb1-202"><a href="#cb1-202" tabindex="-1"></a>          <span class="st">`</span><span class="at">*</span><span class="st">`</span></span>
<span id="cb1-203"><a href="#cb1-203" tabindex="-1"></a>        ),</span>
<span id="cb1-204"><a href="#cb1-204" tabindex="-1"></a>        <span class="at">dims =</span> <span class="dv">2</span></span>
<span id="cb1-205"><a href="#cb1-205" tabindex="-1"></a>      )</span>
<span id="cb1-206"><a href="#cb1-206" tabindex="-1"></a>  }</span>
<span id="cb1-207"><a href="#cb1-207" tabindex="-1"></a>  hessian <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, <span class="at">ncol =</span> p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb1-208"><a href="#cb1-208" tabindex="-1"></a>  hessian[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span></span>
<span id="cb1-209"><a href="#cb1-209" tabindex="-1"></a>    <span class="fu">crossprod</span>(phi_coefficient) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb1-210"><a href="#cb1-210" tabindex="-1"></a>  hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span> (</span>
<span id="cb1-211"><a href="#cb1-211" tabindex="-1"></a>    <span class="fu">rowSums</span>(</span>
<span id="cb1-212"><a href="#cb1-212" tabindex="-1"></a>      <span class="fu">sweep</span>(</span>
<span id="cb1-213"><a href="#cb1-213" tabindex="-1"></a>        phi_psi_coefficient,</span>
<span id="cb1-214"><a href="#cb1-214" tabindex="-1"></a>        <span class="dv">3</span>,</span>
<span id="cb1-215"><a href="#cb1-215" tabindex="-1"></a>        variance_term,</span>
<span id="cb1-216"><a href="#cb1-216" tabindex="-1"></a>        <span class="st">`</span><span class="at">*</span><span class="st">`</span></span>
<span id="cb1-217"><a href="#cb1-217" tabindex="-1"></a>      ),</span>
<span id="cb1-218"><a href="#cb1-218" tabindex="-1"></a>      <span class="at">dims =</span> <span class="dv">2</span></span>
<span id="cb1-219"><a href="#cb1-219" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb1-220"><a href="#cb1-220" tabindex="-1"></a>      <span class="fu">crossprod</span>(</span>
<span id="cb1-221"><a href="#cb1-221" tabindex="-1"></a>        psi_coefficient, phi_coefficient</span>
<span id="cb1-222"><a href="#cb1-222" tabindex="-1"></a>      )</span>
<span id="cb1-223"><a href="#cb1-223" tabindex="-1"></a>  ) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb1-224"><a href="#cb1-224" tabindex="-1"></a>  hessian[<span class="dv">1</span><span class="sc">:</span>p, (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="ot">&lt;-</span> <span class="fu">t</span>(hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), <span class="dv">1</span><span class="sc">:</span>p])</span>
<span id="cb1-225"><a href="#cb1-225" tabindex="-1"></a>  hessian[<span class="dv">1</span><span class="sc">:</span>p, p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb1-226"><a href="#cb1-226" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">crossprod</span>(phi_coefficient, variance_term) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-227"><a href="#cb1-227" tabindex="-1"></a>  hessian[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span> <span class="fu">t</span>(hessian[<span class="dv">1</span><span class="sc">:</span>p, p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb1-228"><a href="#cb1-228" tabindex="-1"></a>  hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="ot">&lt;-</span> (</span>
<span id="cb1-229"><a href="#cb1-229" tabindex="-1"></a>    <span class="fu">crossprod</span>(psi_coefficient) <span class="sc">+</span> <span class="fu">rowSums</span>(</span>
<span id="cb1-230"><a href="#cb1-230" tabindex="-1"></a>      <span class="fu">sweep</span>(</span>
<span id="cb1-231"><a href="#cb1-231" tabindex="-1"></a>        psi_psi_coefficient,</span>
<span id="cb1-232"><a href="#cb1-232" tabindex="-1"></a>        <span class="dv">3</span>,</span>
<span id="cb1-233"><a href="#cb1-233" tabindex="-1"></a>        variance_term,</span>
<span id="cb1-234"><a href="#cb1-234" tabindex="-1"></a>        <span class="st">`</span><span class="at">*</span><span class="st">`</span></span>
<span id="cb1-235"><a href="#cb1-235" tabindex="-1"></a>      ),</span>
<span id="cb1-236"><a href="#cb1-236" tabindex="-1"></a>      <span class="at">dims =</span> <span class="dv">2</span></span>
<span id="cb1-237"><a href="#cb1-237" tabindex="-1"></a>    )</span>
<span id="cb1-238"><a href="#cb1-238" tabindex="-1"></a>  ) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb1-239"><a href="#cb1-239" tabindex="-1"></a>  hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb1-240"><a href="#cb1-240" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">crossprod</span>(psi_coefficient, variance_term) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-241"><a href="#cb1-241" tabindex="-1"></a>  hessian[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="ot">&lt;-</span></span>
<span id="cb1-242"><a href="#cb1-242" tabindex="-1"></a>    <span class="fu">t</span>(hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb1-243"><a href="#cb1-243" tabindex="-1"></a>  hessian[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb1-244"><a href="#cb1-244" tabindex="-1"></a>    <span class="fu">crossprod</span>(variance_term) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">3</span> <span class="sc">-</span></span>
<span id="cb1-245"><a href="#cb1-245" tabindex="-1"></a>    (<span class="fu">nrow</span>(data) <span class="sc">-</span> q) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-246"><a href="#cb1-246" tabindex="-1"></a>  hessian</span>
<span id="cb1-247"><a href="#cb1-247" tabindex="-1"></a>}</span>
<span id="cb1-248"><a href="#cb1-248" tabindex="-1"></a></span>
<span id="cb1-249"><a href="#cb1-249" tabindex="-1"></a><span class="co"># fastcpd arma 1 1</span></span>
<span id="cb1-250"><a href="#cb1-250" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb1-251"><a href="#cb1-251" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">600</span></span>
<span id="cb1-252"><a href="#cb1-252" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb1-253"><a href="#cb1-253" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb1-254"><a href="#cb1-254" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">300</span>) {</span>
<span id="cb1-255"><a href="#cb1-255" tabindex="-1"></a>  x[i <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="sc">*</span> x[i] <span class="sc">+</span> w[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> w[i]</span>
<span id="cb1-256"><a href="#cb1-256" tabindex="-1"></a>}</span>
<span id="cb1-257"><a href="#cb1-257" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">301</span><span class="sc">:</span>n) {</span>
<span id="cb1-258"><a href="#cb1-258" tabindex="-1"></a>  x[i <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fl">0.3</span> <span class="sc">*</span> x[i] <span class="sc">+</span> w[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> w[i]</span>
<span id="cb1-259"><a href="#cb1-259" tabindex="-1"></a>}</span>
<span id="cb1-260"><a href="#cb1-260" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">fastcpd</span>(</span>
<span id="cb1-261"><a href="#cb1-261" tabindex="-1"></a>  <span class="at">formula =</span> <span class="sc">~</span> . <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb1-262"><a href="#cb1-262" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x[<span class="dv">1</span> <span class="sc">+</span> <span class="fu">seq_len</span>(n)]),</span>
<span id="cb1-263"><a href="#cb1-263" tabindex="-1"></a>  <span class="at">trim =</span> <span class="dv">0</span>,</span>
<span id="cb1-264"><a href="#cb1-264" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb1-265"><a href="#cb1-265" tabindex="-1"></a>  <span class="at">beta =</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">log</span>(n) <span class="sc">/</span> <span class="dv">2</span>,</span>
<span id="cb1-266"><a href="#cb1-266" tabindex="-1"></a>  <span class="at">cost_adjustment =</span> <span class="st">&quot;BIC&quot;</span>,</span>
<span id="cb1-267"><a href="#cb1-267" tabindex="-1"></a>  <span class="at">cost =</span> qmle,</span>
<span id="cb1-268"><a href="#cb1-268" tabindex="-1"></a>  <span class="at">cost_gradient =</span> qmle_gradient,</span>
<span id="cb1-269"><a href="#cb1-269" tabindex="-1"></a>  <span class="at">cost_hessian =</span> qmle_hessian,</span>
<span id="cb1-270"><a href="#cb1-270" tabindex="-1"></a>  <span class="at">cp_only =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-271"><a href="#cb1-271" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span>), <span class="fl">1e-10</span>),</span>
<span id="cb1-272"><a href="#cb1-272" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span>), <span class="cn">Inf</span>),</span>
<span id="cb1-273"><a href="#cb1-273" tabindex="-1"></a>  <span class="at">line_search =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="fl">1e-2</span>, <span class="fl">1e-3</span>, <span class="fl">1e-4</span>, <span class="fl">1e-5</span>, <span class="fl">1e-6</span>, <span class="fl">1e-7</span>, <span class="fl">1e-8</span>, <span class="fl">1e-9</span>),</span>
<span id="cb1-274"><a href="#cb1-274" tabindex="-1"></a>  <span class="at">r.progress =</span> <span class="cn">FALSE</span></span>
<span id="cb1-275"><a href="#cb1-275" tabindex="-1"></a>)</span>
<span id="cb1-276"><a href="#cb1-276" tabindex="-1"></a><span class="fu">summary</span>(result)</span>
<span id="cb1-277"><a href="#cb1-277" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-278"><a href="#cb1-278" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb1-279"><a href="#cb1-279" tabindex="-1"></a><span class="co">#&gt; fastcpd(formula = ~. - 1, data = data.frame(x = x[1 + seq_len(n)]), </span></span>
<span id="cb1-280"><a href="#cb1-280" tabindex="-1"></a><span class="co">#&gt;     beta = (1 + 1 + 1 + 1) * log(n)/2, cost_adjustment = &quot;BIC&quot;, </span></span>
<span id="cb1-281"><a href="#cb1-281" tabindex="-1"></a><span class="co">#&gt;     cost = qmle, cost_gradient = qmle_gradient, cost_hessian = qmle_hessian, </span></span>
<span id="cb1-282"><a href="#cb1-282" tabindex="-1"></a><span class="co">#&gt;     line_search = c(1, 0.1, 0.01, 0.001, 1e-04, 1e-05, 1e-06, </span></span>
<span id="cb1-283"><a href="#cb1-283" tabindex="-1"></a><span class="co">#&gt;         1e-07, 1e-08, 1e-09), lower = c(rep(-1, 1 + 1), 1e-10), </span></span>
<span id="cb1-284"><a href="#cb1-284" tabindex="-1"></a><span class="co">#&gt;     upper = c(rep(1, 1 + 1), Inf), trim = 0, p = 1 + 1 + 1, cp_only = TRUE, </span></span>
<span id="cb1-285"><a href="#cb1-285" tabindex="-1"></a><span class="co">#&gt;     r.progress = FALSE)</span></span>
<span id="cb1-286"><a href="#cb1-286" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-287"><a href="#cb1-287" tabindex="-1"></a><span class="co">#&gt; Change points:</span></span>
<span id="cb1-288"><a href="#cb1-288" tabindex="-1"></a><span class="co">#&gt; 3 300</span></span>
<span id="cb1-289"><a href="#cb1-289" tabindex="-1"></a></span>
<span id="cb1-290"><a href="#cb1-290" tabindex="-1"></a><span class="co"># fastcpd arma 3 2</span></span>
<span id="cb1-291"><a href="#cb1-291" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb1-292"><a href="#cb1-292" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">600</span></span>
<span id="cb1-293"><a href="#cb1-293" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n <span class="sc">+</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb1-294"><a href="#cb1-294" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n <span class="sc">+</span> <span class="dv">3</span>)</span>
<span id="cb1-295"><a href="#cb1-295" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">300</span>) {</span>
<span id="cb1-296"><a href="#cb1-296" tabindex="-1"></a>  x[i <span class="sc">+</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="sc">*</span> x[i <span class="sc">+</span> <span class="dv">2</span>] <span class="sc">-</span> <span class="fl">0.2</span> <span class="sc">*</span> x[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> x[i] <span class="sc">+</span></span>
<span id="cb1-297"><a href="#cb1-297" tabindex="-1"></a>    w[i <span class="sc">+</span> <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> w[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> w[i]</span>
<span id="cb1-298"><a href="#cb1-298" tabindex="-1"></a>}</span>
<span id="cb1-299"><a href="#cb1-299" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">301</span><span class="sc">:</span>n) {</span>
<span id="cb1-300"><a href="#cb1-300" tabindex="-1"></a>  x[i <span class="sc">+</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fl">0.3</span> <span class="sc">*</span> x[i <span class="sc">+</span> <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> x[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> x[i] <span class="sc">+</span></span>
<span id="cb1-301"><a href="#cb1-301" tabindex="-1"></a>    w[i <span class="sc">+</span> <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> w[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> w[i]</span>
<span id="cb1-302"><a href="#cb1-302" tabindex="-1"></a>}</span>
<span id="cb1-303"><a href="#cb1-303" tabindex="-1"></a><span class="co"># result &lt;- fastcpd(</span></span>
<span id="cb1-304"><a href="#cb1-304" tabindex="-1"></a><span class="co">#   formula = ~ . - 1,</span></span>
<span id="cb1-305"><a href="#cb1-305" tabindex="-1"></a><span class="co">#   data = data.frame(x = x[3 + seq_len(n)]),</span></span>
<span id="cb1-306"><a href="#cb1-306" tabindex="-1"></a><span class="co">#   trim = 0,</span></span>
<span id="cb1-307"><a href="#cb1-307" tabindex="-1"></a><span class="co">#   p = 3 + 2 + 1,</span></span>
<span id="cb1-308"><a href="#cb1-308" tabindex="-1"></a><span class="co">#   beta = (3 + 2 + 1 + 1) * log(n) / 2,</span></span>
<span id="cb1-309"><a href="#cb1-309" tabindex="-1"></a><span class="co">#   cost_adjustment = &quot;BIC&quot;,</span></span>
<span id="cb1-310"><a href="#cb1-310" tabindex="-1"></a><span class="co">#   cost = function(data, theta) {</span></span>
<span id="cb1-311"><a href="#cb1-311" tabindex="-1"></a><span class="co">#     qmle(data, theta, 3, 2)</span></span>
<span id="cb1-312"><a href="#cb1-312" tabindex="-1"></a><span class="co">#   },</span></span>
<span id="cb1-313"><a href="#cb1-313" tabindex="-1"></a><span class="co">#   cost_gradient = function(data, theta) {</span></span>
<span id="cb1-314"><a href="#cb1-314" tabindex="-1"></a><span class="co">#     qmle_gradient(data, theta, 3, 2)</span></span>
<span id="cb1-315"><a href="#cb1-315" tabindex="-1"></a><span class="co">#   },</span></span>
<span id="cb1-316"><a href="#cb1-316" tabindex="-1"></a><span class="co">#   cost_hessian = function(data, theta) {</span></span>
<span id="cb1-317"><a href="#cb1-317" tabindex="-1"></a><span class="co">#     qmle_hessian(data, theta, 3, 2)</span></span>
<span id="cb1-318"><a href="#cb1-318" tabindex="-1"></a><span class="co">#   },</span></span>
<span id="cb1-319"><a href="#cb1-319" tabindex="-1"></a><span class="co">#   cp_only = TRUE,</span></span>
<span id="cb1-320"><a href="#cb1-320" tabindex="-1"></a><span class="co">#   lower = c(rep(-1, 3 + 2), 1e-10),</span></span>
<span id="cb1-321"><a href="#cb1-321" tabindex="-1"></a><span class="co">#   upper = c(rep(1, 3 + 2), Inf),</span></span>
<span id="cb1-322"><a href="#cb1-322" tabindex="-1"></a><span class="co">#   line_search = c(1, 0.1, 1e-2, 1e-3, 1e-4, 1e-5, 1e-6, 1e-7, 1e-8, 1e-9),</span></span>
<span id="cb1-323"><a href="#cb1-323" tabindex="-1"></a><span class="co">#   r.progress = FALSE</span></span>
<span id="cb1-324"><a href="#cb1-324" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb1-325"><a href="#cb1-325" tabindex="-1"></a><span class="co"># summary(result)</span></span>
<span id="cb1-326"><a href="#cb1-326" tabindex="-1"></a></span>
<span id="cb1-327"><a href="#cb1-327" tabindex="-1"></a><span class="co"># hessian check</span></span>
<span id="cb1-328"><a href="#cb1-328" tabindex="-1"></a>theta_estimate <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fl">0.1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb1-329"><a href="#cb1-329" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">expect_equal</span>(</span>
<span id="cb1-330"><a href="#cb1-330" tabindex="-1"></a>  numDeriv<span class="sc">::</span><span class="fu">hessian</span>(</span>
<span id="cb1-331"><a href="#cb1-331" tabindex="-1"></a>    qmle, theta_estimate, <span class="at">data =</span> <span class="fu">matrix</span>(x[<span class="dv">3</span> <span class="sc">+</span> <span class="fu">seq_len</span>(n)]), <span class="at">p =</span> <span class="dv">3</span>, <span class="at">q =</span> <span class="dv">2</span></span>
<span id="cb1-332"><a href="#cb1-332" tabindex="-1"></a>  ),</span>
<span id="cb1-333"><a href="#cb1-333" tabindex="-1"></a>  <span class="fu">qmle_hessian_sum</span>(<span class="fu">matrix</span>(x[<span class="dv">3</span> <span class="sc">+</span> <span class="fu">seq_len</span>(n)]), theta_estimate, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb1-334"><a href="#cb1-334" tabindex="-1"></a>)</span>
<span id="cb1-335"><a href="#cb1-335" tabindex="-1"></a></span>
<span id="cb1-336"><a href="#cb1-336" tabindex="-1"></a><span class="fu">optim</span>(</span>
<span id="cb1-337"><a href="#cb1-337" tabindex="-1"></a>  <span class="fu">rep</span>(<span class="fl">0.1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb1-338"><a href="#cb1-338" tabindex="-1"></a>  <span class="at">fn =</span> <span class="cf">function</span>(data, theta) {</span>
<span id="cb1-339"><a href="#cb1-339" tabindex="-1"></a>    <span class="fu">qmle</span>(data, theta, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb1-340"><a href="#cb1-340" tabindex="-1"></a>  },</span>
<span id="cb1-341"><a href="#cb1-341" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">matrix</span>(x[<span class="dv">3</span> <span class="sc">+</span> <span class="fu">seq_len</span>(n)]),</span>
<span id="cb1-342"><a href="#cb1-342" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;L-BFGS-B&quot;</span>,</span>
<span id="cb1-343"><a href="#cb1-343" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="fl">1e-10</span>),</span>
<span id="cb1-344"><a href="#cb1-344" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="cn">Inf</span>),</span>
<span id="cb1-345"><a href="#cb1-345" tabindex="-1"></a>  <span class="at">gr =</span> <span class="cf">function</span>(data, theta) {</span>
<span id="cb1-346"><a href="#cb1-346" tabindex="-1"></a>    <span class="fu">qmle_gradient_sum</span>(data, theta, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb1-347"><a href="#cb1-347" tabindex="-1"></a>  }</span>
<span id="cb1-348"><a href="#cb1-348" tabindex="-1"></a>)</span>
<span id="cb1-349"><a href="#cb1-349" tabindex="-1"></a><span class="co">#&gt; $par</span></span>
<span id="cb1-350"><a href="#cb1-350" tabindex="-1"></a><span class="co">#&gt; [1]  0.2255153 -0.1465193  0.6170471  0.2376060  0.5062720  1.1398935</span></span>
<span id="cb1-351"><a href="#cb1-351" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-352"><a href="#cb1-352" tabindex="-1"></a><span class="co">#&gt; $value</span></span>
<span id="cb1-353"><a href="#cb1-353" tabindex="-1"></a><span class="co">#&gt; [1] 887.6911</span></span>
<span id="cb1-354"><a href="#cb1-354" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-355"><a href="#cb1-355" tabindex="-1"></a><span class="co">#&gt; $counts</span></span>
<span id="cb1-356"><a href="#cb1-356" tabindex="-1"></a><span class="co">#&gt; function gradient </span></span>
<span id="cb1-357"><a href="#cb1-357" tabindex="-1"></a><span class="co">#&gt;       25       25 </span></span>
<span id="cb1-358"><a href="#cb1-358" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-359"><a href="#cb1-359" tabindex="-1"></a><span class="co">#&gt; $convergence</span></span>
<span id="cb1-360"><a href="#cb1-360" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb1-361"><a href="#cb1-361" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-362"><a href="#cb1-362" tabindex="-1"></a><span class="co">#&gt; $message</span></span>
<span id="cb1-363"><a href="#cb1-363" tabindex="-1"></a><span class="co">#&gt; [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot;</span></span>
<span id="cb1-364"><a href="#cb1-364" tabindex="-1"></a></span>
<span id="cb1-365"><a href="#cb1-365" tabindex="-1"></a><span class="co"># convergence check</span></span>
<span id="cb1-366"><a href="#cb1-366" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">arima.sim</span>(<span class="fu">list</span>(<span class="at">ar =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="sc">-</span><span class="fl">0.2</span>, <span class="fl">0.6</span>), <span class="at">ma =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>)), <span class="at">n =</span> n <span class="sc">+</span> <span class="dv">3</span>)</span>
<span id="cb1-367"><a href="#cb1-367" tabindex="-1"></a>theta_estimate <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fl">0.1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb1-368"><a href="#cb1-368" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">matrix</span>(x[<span class="dv">3</span> <span class="sc">+</span> <span class="fu">seq_len</span>(n)])</span>
<span id="cb1-369"><a href="#cb1-369" tabindex="-1"></a>qmle_path <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-370"><a href="#cb1-370" tabindex="-1"></a>prev_qmle <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-371"><a href="#cb1-371" tabindex="-1"></a>curr_qmle <span class="ot">&lt;-</span> <span class="cn">Inf</span></span>
<span id="cb1-372"><a href="#cb1-372" tabindex="-1"></a>epochs_num <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-373"><a href="#cb1-373" tabindex="-1"></a><span class="cf">while</span> (<span class="fu">abs</span>(curr_qmle <span class="sc">-</span> prev_qmle) <span class="sc">&gt;</span> <span class="fl">1e-5</span>) {</span>
<span id="cb1-374"><a href="#cb1-374" tabindex="-1"></a>  prev_qmle <span class="ot">&lt;-</span> curr_qmle</span>
<span id="cb1-375"><a href="#cb1-375" tabindex="-1"></a>  hessian <span class="ot">&lt;-</span></span>
<span id="cb1-376"><a href="#cb1-376" tabindex="-1"></a>    Matrix<span class="sc">::</span><span class="fu">nearPD</span>(<span class="fu">qmle_hessian_sum</span>(data, theta_estimate, <span class="dv">3</span>, <span class="dv">2</span>))<span class="sc">$</span>mat</span>
<span id="cb1-377"><a href="#cb1-377" tabindex="-1"></a>  step <span class="ot">&lt;-</span> <span class="fu">solve</span>(</span>
<span id="cb1-378"><a href="#cb1-378" tabindex="-1"></a>    hessian, <span class="fu">qmle_gradient_sum</span>(data, theta_estimate, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb1-379"><a href="#cb1-379" tabindex="-1"></a>  )</span>
<span id="cb1-380"><a href="#cb1-380" tabindex="-1"></a>  <span class="co"># line search</span></span>
<span id="cb1-381"><a href="#cb1-381" tabindex="-1"></a>  lr_choices <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="fl">1e-2</span>, <span class="fl">1e-3</span>, <span class="fl">1e-4</span>, <span class="fl">1e-5</span>, <span class="fl">1e-6</span>, <span class="fl">1e-7</span>, <span class="fl">1e-8</span>, <span class="fl">1e-9</span>)</span>
<span id="cb1-382"><a href="#cb1-382" tabindex="-1"></a>  lr <span class="ot">&lt;-</span> lr_choices[<span class="fu">which.min</span>(</span>
<span id="cb1-383"><a href="#cb1-383" tabindex="-1"></a>    <span class="fu">sapply</span>(lr_choices, <span class="cf">function</span>(lr) {</span>
<span id="cb1-384"><a href="#cb1-384" tabindex="-1"></a>      <span class="fu">qmle</span>(data, <span class="fu">pmin</span>(</span>
<span id="cb1-385"><a href="#cb1-385" tabindex="-1"></a>        <span class="fu">pmax</span>(theta_estimate <span class="sc">-</span> lr <span class="sc">*</span> step, <span class="fu">c</span>(<span class="fu">rep</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="fl">1e-10</span>)),</span>
<span id="cb1-386"><a href="#cb1-386" tabindex="-1"></a>        <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="cn">Inf</span>)</span>
<span id="cb1-387"><a href="#cb1-387" tabindex="-1"></a>      ), <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb1-388"><a href="#cb1-388" tabindex="-1"></a>    })</span>
<span id="cb1-389"><a href="#cb1-389" tabindex="-1"></a>  )]</span>
<span id="cb1-390"><a href="#cb1-390" tabindex="-1"></a>  theta_estimate <span class="ot">&lt;-</span> <span class="fu">pmin</span>(</span>
<span id="cb1-391"><a href="#cb1-391" tabindex="-1"></a>    <span class="fu">pmax</span>(theta_estimate <span class="sc">-</span> lr <span class="sc">*</span> step, <span class="fu">c</span>(<span class="fu">rep</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="fl">1e-10</span>)),</span>
<span id="cb1-392"><a href="#cb1-392" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="cn">Inf</span>)</span>
<span id="cb1-393"><a href="#cb1-393" tabindex="-1"></a>  )</span>
<span id="cb1-394"><a href="#cb1-394" tabindex="-1"></a>  curr_qmle <span class="ot">&lt;-</span> <span class="fu">qmle</span>(data, theta_estimate, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb1-395"><a href="#cb1-395" tabindex="-1"></a>  <span class="fu">cat</span>(epochs_num, curr_qmle, theta_estimate, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb1-396"><a href="#cb1-396" tabindex="-1"></a>  qmle_path <span class="ot">&lt;-</span> <span class="fu">c</span>(qmle_path, curr_qmle)</span>
<span id="cb1-397"><a href="#cb1-397" tabindex="-1"></a>  epochs_num <span class="ot">&lt;-</span> epochs_num <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb1-398"><a href="#cb1-398" tabindex="-1"></a>}</span>
<span id="cb1-399"><a href="#cb1-399" tabindex="-1"></a><span class="co">#&gt; 0 3944.634 0.04233446 -0.001623946 0.1377787 0.115717 0.2221914 0.09941663 </span></span>
<span id="cb1-400"><a href="#cb1-400" tabindex="-1"></a><span class="co">#&gt; 1 3936.952 0.01542032 -0.0531825 0.1509683 0.1246861 0.2805771 0.09928027 </span></span>
<span id="cb1-401"><a href="#cb1-401" tabindex="-1"></a><span class="co">#&gt; 2 3910.965 -0.08797532 -0.242957 0.1906819 0.170578 0.4839799 0.09910547 </span></span>
<span id="cb1-402"><a href="#cb1-402" tabindex="-1"></a><span class="co">#&gt; 3 3848.468 -0.04161028 -0.07070869 0.2030628 0.1721869 0.3068375 0.09787254 </span></span>
<span id="cb1-403"><a href="#cb1-403" tabindex="-1"></a><span class="co">#&gt; 4 3831.932 0.1216262 0.08513928 0.1587053 0.009073249 0.192338 0.09769375 </span></span>
<span id="cb1-404"><a href="#cb1-404" tabindex="-1"></a><span class="co">#&gt; 5 3776.199 -0.01651633 -0.01397911 0.2307269 0.1592173 0.2581484 0.09649129 </span></span>
<span id="cb1-405"><a href="#cb1-405" tabindex="-1"></a><span class="co">#&gt; 6 3765.216 -0.1259345 -0.2358653 0.2811266 0.2247347 0.4917298 0.09625032 </span></span>
<span id="cb1-406"><a href="#cb1-406" tabindex="-1"></a><span class="co">#&gt; 7 3747.53 -0.2338781 -0.2000905 0.3095502 0.381256 0.4029239 0.09616148 </span></span>
<span id="cb1-407"><a href="#cb1-407" tabindex="-1"></a><span class="co">#&gt; 8 3716.551 -0.153926 -0.2491416 0.3136961 0.2642216 0.4770571 0.09560175 </span></span>
<span id="cb1-408"><a href="#cb1-408" tabindex="-1"></a><span class="co">#&gt; 9 3713.008 -0.123153 -0.2626475 0.3090286 0.221204 0.5032787 0.09552786 </span></span>
<span id="cb1-409"><a href="#cb1-409" tabindex="-1"></a><span class="co">#&gt; 10 3711.746 -0.1027739 -0.2675548 0.3047442 0.1937621 0.5168513 0.09550011 </span></span>
<span id="cb1-410"><a href="#cb1-410" tabindex="-1"></a><span class="co">#&gt; 11 3710.812 0.07776053 -0.2838975 0.2622506 -0.04304759 0.610297 0.09530323 </span></span>
<span id="cb1-411"><a href="#cb1-411" tabindex="-1"></a><span class="co">#&gt; 12 2459.683 -0.07466526 -0.1866228 0.5580706 0.2496629 0.398122 0.1325774 </span></span>
<span id="cb1-412"><a href="#cb1-412" tabindex="-1"></a><span class="co">#&gt; 13 1756.478 0.01341224 -0.1173666 0.5715505 0.1583534 0.34973 0.1930662 </span></span>
<span id="cb1-413"><a href="#cb1-413" tabindex="-1"></a><span class="co">#&gt; 14 1337.572 0.04397173 -0.09448422 0.5641567 0.1253938 0.3330598 0.279927 </span></span>
<span id="cb1-414"><a href="#cb1-414" tabindex="-1"></a><span class="co">#&gt; 15 1094.001 0.0589584 -0.08427659 0.5583676 0.1088234 0.3254585 0.3992378 </span></span>
<span id="cb1-415"><a href="#cb1-415" tabindex="-1"></a><span class="co">#&gt; 16 962.9662 0.06613462 -0.0797346 0.5551347 0.1007856 0.3220491 0.5542437 </span></span>
<span id="cb1-416"><a href="#cb1-416" tabindex="-1"></a><span class="co">#&gt; 17 901.8344 0.06929215 -0.07782492 0.5536197 0.09722635 0.3206128 0.7372815 </span></span>
<span id="cb1-417"><a href="#cb1-417" tabindex="-1"></a><span class="co">#&gt; 18 880.06 0.07048913 -0.0771186 0.5530292 0.09587296 0.3200815 0.9184269 </span></span>
<span id="cb1-418"><a href="#cb1-418" tabindex="-1"></a><span class="co">#&gt; 19 875.545 0.07082844 -0.07692082 0.5528597 0.09548877 0.3199327 1.045147 </span></span>
<span id="cb1-419"><a href="#cb1-419" tabindex="-1"></a><span class="co">#&gt; 20 875.2373 0.07088068 -0.07689054 0.5528334 0.09542957 0.3199099 1.089357 </span></span>
<span id="cb1-420"><a href="#cb1-420" tabindex="-1"></a><span class="co">#&gt; 21 875.2352 0.07088299 -0.0768892 0.5528323 0.09542696 0.3199089 1.093412 </span></span>
<span id="cb1-421"><a href="#cb1-421" tabindex="-1"></a><span class="co">#&gt; 22 875.2352 0.070883 -0.0768892 0.5528323 0.09542695 0.3199089 1.093443</span></span></code></pre></div>
</div>
<div id="notes" class="section level1">
<h1>Notes</h1>
<p>This document is generated by the following code:</p>
<pre class="shell"><code>R -e &#39;knitr::knit(&quot;vignettes/exploration-during-development.Rmd.original&quot;, output = &quot;vignettes/exploration-during-development.Rmd&quot;)&#39;</code></pre>
</div>
<div id="appendix-all-code-snippets" class="section level1">
<h1>Appendix: all code snippets</h1>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  <span class="at">collapse =</span> <span class="cn">TRUE</span>, <span class="at">comment =</span> <span class="st">&quot;#&gt;&quot;</span>, <span class="at">eval =</span> <span class="cn">TRUE</span>, <span class="at">warning =</span> <span class="cn">FALSE</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="fu">library</span>(fastcpd)</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>qmle <span class="ot">&lt;-</span> <span class="cf">function</span>(data, theta, <span class="at">p =</span> <span class="dv">1</span>, <span class="at">q =</span> <span class="dv">1</span>) {</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data) <span class="sc">&lt;</span> <span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>) {</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>    <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>  }</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>  variance_term <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>    variance_term[i] <span class="ot">&lt;-</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>      data[i] <span class="sc">-</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>      theta[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)]</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>  }</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>  (<span class="fu">log</span>(<span class="dv">2</span> <span class="sc">*</span> pi) <span class="sc">+</span> <span class="fu">log</span>(theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>])) <span class="sc">*</span> (<span class="fu">nrow</span>(data) <span class="sc">-</span> q) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>    <span class="fu">sum</span>(variance_term<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>}</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>qmle_gradient <span class="ot">&lt;-</span> <span class="cf">function</span>(data, theta, <span class="at">p =</span> <span class="dv">1</span>, <span class="at">q =</span> <span class="dv">1</span>) {</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data) <span class="sc">&lt;</span> <span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>) {</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(theta)))</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>  }</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>  variance_term <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>    variance_term[i] <span class="ot">&lt;-</span></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>      data[i] <span class="sc">-</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>      theta[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)]</span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>  }</span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>  phi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), p)</span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>  psi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), q)</span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>    phi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>      <span class="sc">-</span>data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> phi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>  }</span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (q <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a>    psi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a>      <span class="sc">-</span>variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)] <span class="sc">-</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a>  }</span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a>    phi_coefficient[<span class="fu">nrow</span>(data), ] <span class="sc">*</span> variance_term[<span class="fu">nrow</span>(data)] <span class="sc">/</span></span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a>      theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>    psi_coefficient[<span class="fu">nrow</span>(data), ] <span class="sc">*</span> variance_term[<span class="fu">nrow</span>(data)] <span class="sc">/</span></span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a>      theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a>    <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">-</span></span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a>      variance_term[<span class="fu">nrow</span>(data)]<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a>  )</span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a>}</span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a>qmle_gradient_sum <span class="ot">&lt;-</span> <span class="cf">function</span>(data, theta, <span class="at">p =</span> <span class="dv">1</span>, <span class="at">q =</span> <span class="dv">1</span>) {</span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data) <span class="sc">&lt;</span> <span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>) {</span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(theta)))</span>
<span id="cb3-54"><a href="#cb3-54" tabindex="-1"></a>  }</span>
<span id="cb3-55"><a href="#cb3-55" tabindex="-1"></a>  variance_term <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb3-56"><a href="#cb3-56" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-57"><a href="#cb3-57" tabindex="-1"></a>    variance_term[i] <span class="ot">&lt;-</span></span>
<span id="cb3-58"><a href="#cb3-58" tabindex="-1"></a>      data[i] <span class="sc">-</span></span>
<span id="cb3-59"><a href="#cb3-59" tabindex="-1"></a>      theta[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb3-60"><a href="#cb3-60" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)]</span>
<span id="cb3-61"><a href="#cb3-61" tabindex="-1"></a>  }</span>
<span id="cb3-62"><a href="#cb3-62" tabindex="-1"></a>  phi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), p)</span>
<span id="cb3-63"><a href="#cb3-63" tabindex="-1"></a>  psi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), q)</span>
<span id="cb3-64"><a href="#cb3-64" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-65"><a href="#cb3-65" tabindex="-1"></a>    phi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb3-66"><a href="#cb3-66" tabindex="-1"></a>      <span class="sc">-</span>data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb3-67"><a href="#cb3-67" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> phi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb3-68"><a href="#cb3-68" tabindex="-1"></a>  }</span>
<span id="cb3-69"><a href="#cb3-69" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (q <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-70"><a href="#cb3-70" tabindex="-1"></a>    psi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb3-71"><a href="#cb3-71" tabindex="-1"></a>      <span class="sc">-</span>variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)] <span class="sc">-</span></span>
<span id="cb3-72"><a href="#cb3-72" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb3-73"><a href="#cb3-73" tabindex="-1"></a>  }</span>
<span id="cb3-74"><a href="#cb3-74" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb3-75"><a href="#cb3-75" tabindex="-1"></a>    <span class="fu">crossprod</span>(phi_coefficient, variance_term) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb3-76"><a href="#cb3-76" tabindex="-1"></a>    <span class="fu">crossprod</span>(psi_coefficient, variance_term) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb3-77"><a href="#cb3-77" tabindex="-1"></a>    (<span class="fu">nrow</span>(data) <span class="sc">-</span> q) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">-</span></span>
<span id="cb3-78"><a href="#cb3-78" tabindex="-1"></a>      <span class="fu">crossprod</span>(variance_term) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb3-79"><a href="#cb3-79" tabindex="-1"></a>  )</span>
<span id="cb3-80"><a href="#cb3-80" tabindex="-1"></a>}</span>
<span id="cb3-81"><a href="#cb3-81" tabindex="-1"></a>qmle_hessian <span class="ot">&lt;-</span> <span class="cf">function</span>(data, theta, <span class="at">p =</span> <span class="dv">1</span>, <span class="at">q =</span> <span class="dv">1</span>) {</span>
<span id="cb3-82"><a href="#cb3-82" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data) <span class="sc">&lt;</span> <span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>) {</span>
<span id="cb3-83"><a href="#cb3-83" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">diag</span>(<span class="fu">length</span>(theta)))</span>
<span id="cb3-84"><a href="#cb3-84" tabindex="-1"></a>  }</span>
<span id="cb3-85"><a href="#cb3-85" tabindex="-1"></a>  variance_term <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb3-86"><a href="#cb3-86" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-87"><a href="#cb3-87" tabindex="-1"></a>    variance_term[i] <span class="ot">&lt;-</span></span>
<span id="cb3-88"><a href="#cb3-88" tabindex="-1"></a>      data[i] <span class="sc">-</span></span>
<span id="cb3-89"><a href="#cb3-89" tabindex="-1"></a>      theta[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb3-90"><a href="#cb3-90" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)]</span>
<span id="cb3-91"><a href="#cb3-91" tabindex="-1"></a>  }</span>
<span id="cb3-92"><a href="#cb3-92" tabindex="-1"></a>  phi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), p)</span>
<span id="cb3-93"><a href="#cb3-93" tabindex="-1"></a>  psi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), q)</span>
<span id="cb3-94"><a href="#cb3-94" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-95"><a href="#cb3-95" tabindex="-1"></a>    phi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb3-96"><a href="#cb3-96" tabindex="-1"></a>      <span class="sc">-</span>data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb3-97"><a href="#cb3-97" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> phi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb3-98"><a href="#cb3-98" tabindex="-1"></a>  }</span>
<span id="cb3-99"><a href="#cb3-99" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (q <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-100"><a href="#cb3-100" tabindex="-1"></a>    psi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb3-101"><a href="#cb3-101" tabindex="-1"></a>      <span class="sc">-</span>variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)] <span class="sc">-</span></span>
<span id="cb3-102"><a href="#cb3-102" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb3-103"><a href="#cb3-103" tabindex="-1"></a>  }</span>
<span id="cb3-104"><a href="#cb3-104" tabindex="-1"></a>  phi_psi_coefficient <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">c</span>(q, p, <span class="fu">nrow</span>(data)))</span>
<span id="cb3-105"><a href="#cb3-105" tabindex="-1"></a>  psi_psi_coefficient <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">c</span>(q, q, <span class="fu">nrow</span>(data)))</span>
<span id="cb3-106"><a href="#cb3-106" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (q <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-107"><a href="#cb3-107" tabindex="-1"></a>    phi_psi_coefficient[, , i] <span class="ot">&lt;-</span></span>
<span id="cb3-108"><a href="#cb3-108" tabindex="-1"></a>      <span class="sc">-</span>phi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ] <span class="sc">-</span></span>
<span id="cb3-109"><a href="#cb3-109" tabindex="-1"></a>      <span class="fu">rowSums</span>(</span>
<span id="cb3-110"><a href="#cb3-110" tabindex="-1"></a>        <span class="fu">sweep</span>(</span>
<span id="cb3-111"><a href="#cb3-111" tabindex="-1"></a>          phi_psi_coefficient[, , (i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb3-112"><a href="#cb3-112" tabindex="-1"></a>          <span class="dv">3</span>,</span>
<span id="cb3-113"><a href="#cb3-113" tabindex="-1"></a>          theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)],</span>
<span id="cb3-114"><a href="#cb3-114" tabindex="-1"></a>          <span class="st">`</span><span class="at">*</span><span class="st">`</span></span>
<span id="cb3-115"><a href="#cb3-115" tabindex="-1"></a>        ),</span>
<span id="cb3-116"><a href="#cb3-116" tabindex="-1"></a>        <span class="at">dims =</span> <span class="dv">2</span></span>
<span id="cb3-117"><a href="#cb3-117" tabindex="-1"></a>      )</span>
<span id="cb3-118"><a href="#cb3-118" tabindex="-1"></a>    psi_psi_coefficient[, , i] <span class="ot">&lt;-</span></span>
<span id="cb3-119"><a href="#cb3-119" tabindex="-1"></a>      <span class="sc">-</span>psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ] <span class="sc">-</span></span>
<span id="cb3-120"><a href="#cb3-120" tabindex="-1"></a>      <span class="fu">t</span>(psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]) <span class="sc">-</span></span>
<span id="cb3-121"><a href="#cb3-121" tabindex="-1"></a>      <span class="fu">rowSums</span>(</span>
<span id="cb3-122"><a href="#cb3-122" tabindex="-1"></a>        <span class="fu">sweep</span>(</span>
<span id="cb3-123"><a href="#cb3-123" tabindex="-1"></a>          psi_psi_coefficient[, , (i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb3-124"><a href="#cb3-124" tabindex="-1"></a>          <span class="dv">3</span>,</span>
<span id="cb3-125"><a href="#cb3-125" tabindex="-1"></a>          theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)],</span>
<span id="cb3-126"><a href="#cb3-126" tabindex="-1"></a>          <span class="st">`</span><span class="at">*</span><span class="st">`</span></span>
<span id="cb3-127"><a href="#cb3-127" tabindex="-1"></a>        ),</span>
<span id="cb3-128"><a href="#cb3-128" tabindex="-1"></a>        <span class="at">dims =</span> <span class="dv">2</span></span>
<span id="cb3-129"><a href="#cb3-129" tabindex="-1"></a>      )</span>
<span id="cb3-130"><a href="#cb3-130" tabindex="-1"></a>  }</span>
<span id="cb3-131"><a href="#cb3-131" tabindex="-1"></a>  hessian <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, <span class="at">ncol =</span> p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb3-132"><a href="#cb3-132" tabindex="-1"></a>  hessian[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span></span>
<span id="cb3-133"><a href="#cb3-133" tabindex="-1"></a>    <span class="fu">crossprod</span>(phi_coefficient[<span class="fu">nrow</span>(data), , <span class="at">drop =</span> <span class="cn">FALSE</span>]) <span class="sc">/</span></span>
<span id="cb3-134"><a href="#cb3-134" tabindex="-1"></a>    theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb3-135"><a href="#cb3-135" tabindex="-1"></a>  hessian[<span class="dv">1</span><span class="sc">:</span>p, (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="ot">&lt;-</span> (</span>
<span id="cb3-136"><a href="#cb3-136" tabindex="-1"></a>    <span class="fu">t</span>(phi_psi_coefficient[, , <span class="fu">nrow</span>(data)]) <span class="sc">*</span> variance_term[<span class="fu">nrow</span>(data)] <span class="sc">+</span></span>
<span id="cb3-137"><a href="#cb3-137" tabindex="-1"></a>      <span class="fu">crossprod</span>(</span>
<span id="cb3-138"><a href="#cb3-138" tabindex="-1"></a>        phi_coefficient[<span class="fu">nrow</span>(data), , <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb3-139"><a href="#cb3-139" tabindex="-1"></a>        psi_coefficient[<span class="fu">nrow</span>(data), , <span class="at">drop =</span> <span class="cn">FALSE</span>]</span>
<span id="cb3-140"><a href="#cb3-140" tabindex="-1"></a>      )</span>
<span id="cb3-141"><a href="#cb3-141" tabindex="-1"></a>  ) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb3-142"><a href="#cb3-142" tabindex="-1"></a>  hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span> <span class="fu">t</span>(hessian[<span class="dv">1</span><span class="sc">:</span>p, (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)])</span>
<span id="cb3-143"><a href="#cb3-143" tabindex="-1"></a>  hessian[<span class="dv">1</span><span class="sc">:</span>p, p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb3-144"><a href="#cb3-144" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">t</span>(phi_coefficient[<span class="fu">nrow</span>(data), ]) <span class="sc">*</span></span>
<span id="cb3-145"><a href="#cb3-145" tabindex="-1"></a>    variance_term[<span class="fu">nrow</span>(data)] <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb3-146"><a href="#cb3-146" tabindex="-1"></a>  hessian[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span> <span class="fu">t</span>(hessian[<span class="dv">1</span><span class="sc">:</span>p, p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb3-147"><a href="#cb3-147" tabindex="-1"></a>  hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="ot">&lt;-</span> (</span>
<span id="cb3-148"><a href="#cb3-148" tabindex="-1"></a>    <span class="fu">crossprod</span>(psi_coefficient[<span class="fu">nrow</span>(data), , <span class="at">drop =</span> <span class="cn">FALSE</span>]) <span class="sc">+</span></span>
<span id="cb3-149"><a href="#cb3-149" tabindex="-1"></a>      psi_psi_coefficient[, , <span class="fu">nrow</span>(data)] <span class="sc">*</span> variance_term[<span class="fu">nrow</span>(data)]</span>
<span id="cb3-150"><a href="#cb3-150" tabindex="-1"></a>  ) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb3-151"><a href="#cb3-151" tabindex="-1"></a>  hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb3-152"><a href="#cb3-152" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">t</span>(psi_coefficient[<span class="fu">nrow</span>(data), ]) <span class="sc">*</span></span>
<span id="cb3-153"><a href="#cb3-153" tabindex="-1"></a>    variance_term[<span class="fu">nrow</span>(data)] <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb3-154"><a href="#cb3-154" tabindex="-1"></a>  hessian[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="ot">&lt;-</span></span>
<span id="cb3-155"><a href="#cb3-155" tabindex="-1"></a>    <span class="fu">t</span>(hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb3-156"><a href="#cb3-156" tabindex="-1"></a>  hessian[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb3-157"><a href="#cb3-157" tabindex="-1"></a>    variance_term[<span class="fu">nrow</span>(data)]<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">3</span> <span class="sc">-</span></span>
<span id="cb3-158"><a href="#cb3-158" tabindex="-1"></a>    <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb3-159"><a href="#cb3-159" tabindex="-1"></a>  hessian</span>
<span id="cb3-160"><a href="#cb3-160" tabindex="-1"></a>}</span>
<span id="cb3-161"><a href="#cb3-161" tabindex="-1"></a>qmle_hessian_sum <span class="ot">&lt;-</span> <span class="cf">function</span>(data, theta, <span class="at">p =</span> <span class="dv">1</span>, <span class="at">q =</span> <span class="dv">1</span>) {</span>
<span id="cb3-162"><a href="#cb3-162" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data) <span class="sc">&lt;</span> <span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>) {</span>
<span id="cb3-163"><a href="#cb3-163" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">diag</span>(<span class="fu">length</span>(theta)))</span>
<span id="cb3-164"><a href="#cb3-164" tabindex="-1"></a>  }</span>
<span id="cb3-165"><a href="#cb3-165" tabindex="-1"></a>  variance_term <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb3-166"><a href="#cb3-166" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-167"><a href="#cb3-167" tabindex="-1"></a>    variance_term[i] <span class="ot">&lt;-</span></span>
<span id="cb3-168"><a href="#cb3-168" tabindex="-1"></a>      data[i] <span class="sc">-</span></span>
<span id="cb3-169"><a href="#cb3-169" tabindex="-1"></a>      theta[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb3-170"><a href="#cb3-170" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)]</span>
<span id="cb3-171"><a href="#cb3-171" tabindex="-1"></a>  }</span>
<span id="cb3-172"><a href="#cb3-172" tabindex="-1"></a>  phi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), p)</span>
<span id="cb3-173"><a href="#cb3-173" tabindex="-1"></a>  psi_coefficient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data), q)</span>
<span id="cb3-174"><a href="#cb3-174" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="fu">max</span>(p, q) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-175"><a href="#cb3-175" tabindex="-1"></a>    phi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb3-176"><a href="#cb3-176" tabindex="-1"></a>      <span class="sc">-</span>data[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> p)] <span class="sc">-</span></span>
<span id="cb3-177"><a href="#cb3-177" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> phi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb3-178"><a href="#cb3-178" tabindex="-1"></a>  }</span>
<span id="cb3-179"><a href="#cb3-179" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (q <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-180"><a href="#cb3-180" tabindex="-1"></a>    psi_coefficient[i, ] <span class="ot">&lt;-</span></span>
<span id="cb3-181"><a href="#cb3-181" tabindex="-1"></a>      <span class="sc">-</span>variance_term[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q)] <span class="sc">-</span></span>
<span id="cb3-182"><a href="#cb3-182" tabindex="-1"></a>      theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="sc">%*%</span> psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]</span>
<span id="cb3-183"><a href="#cb3-183" tabindex="-1"></a>  }</span>
<span id="cb3-184"><a href="#cb3-184" tabindex="-1"></a>  phi_psi_coefficient <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">c</span>(q, p, <span class="fu">nrow</span>(data)))</span>
<span id="cb3-185"><a href="#cb3-185" tabindex="-1"></a>  psi_psi_coefficient <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">c</span>(q, q, <span class="fu">nrow</span>(data)))</span>
<span id="cb3-186"><a href="#cb3-186" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (q <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data)) {</span>
<span id="cb3-187"><a href="#cb3-187" tabindex="-1"></a>    phi_psi_coefficient[, , i] <span class="ot">&lt;-</span></span>
<span id="cb3-188"><a href="#cb3-188" tabindex="-1"></a>      <span class="sc">-</span>phi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ] <span class="sc">-</span></span>
<span id="cb3-189"><a href="#cb3-189" tabindex="-1"></a>      <span class="fu">rowSums</span>(</span>
<span id="cb3-190"><a href="#cb3-190" tabindex="-1"></a>        <span class="fu">sweep</span>(</span>
<span id="cb3-191"><a href="#cb3-191" tabindex="-1"></a>          phi_psi_coefficient[, , (i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb3-192"><a href="#cb3-192" tabindex="-1"></a>          <span class="dv">3</span>,</span>
<span id="cb3-193"><a href="#cb3-193" tabindex="-1"></a>          theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)],</span>
<span id="cb3-194"><a href="#cb3-194" tabindex="-1"></a>          <span class="st">`</span><span class="at">*</span><span class="st">`</span></span>
<span id="cb3-195"><a href="#cb3-195" tabindex="-1"></a>        ),</span>
<span id="cb3-196"><a href="#cb3-196" tabindex="-1"></a>        <span class="at">dims =</span> <span class="dv">2</span></span>
<span id="cb3-197"><a href="#cb3-197" tabindex="-1"></a>      )</span>
<span id="cb3-198"><a href="#cb3-198" tabindex="-1"></a>    psi_psi_coefficient[, , i] <span class="ot">&lt;-</span></span>
<span id="cb3-199"><a href="#cb3-199" tabindex="-1"></a>      <span class="sc">-</span>psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ] <span class="sc">-</span></span>
<span id="cb3-200"><a href="#cb3-200" tabindex="-1"></a>      <span class="fu">t</span>(psi_coefficient[(i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), ]) <span class="sc">-</span></span>
<span id="cb3-201"><a href="#cb3-201" tabindex="-1"></a>      <span class="fu">rowSums</span>(</span>
<span id="cb3-202"><a href="#cb3-202" tabindex="-1"></a>        <span class="fu">sweep</span>(</span>
<span id="cb3-203"><a href="#cb3-203" tabindex="-1"></a>          psi_psi_coefficient[, , (i <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span>(i <span class="sc">-</span> q), <span class="at">drop =</span> <span class="cn">FALSE</span>],</span>
<span id="cb3-204"><a href="#cb3-204" tabindex="-1"></a>          <span class="dv">3</span>,</span>
<span id="cb3-205"><a href="#cb3-205" tabindex="-1"></a>          theta[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)],</span>
<span id="cb3-206"><a href="#cb3-206" tabindex="-1"></a>          <span class="st">`</span><span class="at">*</span><span class="st">`</span></span>
<span id="cb3-207"><a href="#cb3-207" tabindex="-1"></a>        ),</span>
<span id="cb3-208"><a href="#cb3-208" tabindex="-1"></a>        <span class="at">dims =</span> <span class="dv">2</span></span>
<span id="cb3-209"><a href="#cb3-209" tabindex="-1"></a>      )</span>
<span id="cb3-210"><a href="#cb3-210" tabindex="-1"></a>  }</span>
<span id="cb3-211"><a href="#cb3-211" tabindex="-1"></a>  hessian <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, <span class="at">ncol =</span> p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb3-212"><a href="#cb3-212" tabindex="-1"></a>  hessian[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span></span>
<span id="cb3-213"><a href="#cb3-213" tabindex="-1"></a>    <span class="fu">crossprod</span>(phi_coefficient) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb3-214"><a href="#cb3-214" tabindex="-1"></a>  hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span> (</span>
<span id="cb3-215"><a href="#cb3-215" tabindex="-1"></a>    <span class="fu">rowSums</span>(</span>
<span id="cb3-216"><a href="#cb3-216" tabindex="-1"></a>      <span class="fu">sweep</span>(</span>
<span id="cb3-217"><a href="#cb3-217" tabindex="-1"></a>        phi_psi_coefficient,</span>
<span id="cb3-218"><a href="#cb3-218" tabindex="-1"></a>        <span class="dv">3</span>,</span>
<span id="cb3-219"><a href="#cb3-219" tabindex="-1"></a>        variance_term,</span>
<span id="cb3-220"><a href="#cb3-220" tabindex="-1"></a>        <span class="st">`</span><span class="at">*</span><span class="st">`</span></span>
<span id="cb3-221"><a href="#cb3-221" tabindex="-1"></a>      ),</span>
<span id="cb3-222"><a href="#cb3-222" tabindex="-1"></a>      <span class="at">dims =</span> <span class="dv">2</span></span>
<span id="cb3-223"><a href="#cb3-223" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb3-224"><a href="#cb3-224" tabindex="-1"></a>      <span class="fu">crossprod</span>(</span>
<span id="cb3-225"><a href="#cb3-225" tabindex="-1"></a>        psi_coefficient, phi_coefficient</span>
<span id="cb3-226"><a href="#cb3-226" tabindex="-1"></a>      )</span>
<span id="cb3-227"><a href="#cb3-227" tabindex="-1"></a>  ) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb3-228"><a href="#cb3-228" tabindex="-1"></a>  hessian[<span class="dv">1</span><span class="sc">:</span>p, (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="ot">&lt;-</span> <span class="fu">t</span>(hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), <span class="dv">1</span><span class="sc">:</span>p])</span>
<span id="cb3-229"><a href="#cb3-229" tabindex="-1"></a>  hessian[<span class="dv">1</span><span class="sc">:</span>p, p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb3-230"><a href="#cb3-230" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">crossprod</span>(phi_coefficient, variance_term) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb3-231"><a href="#cb3-231" tabindex="-1"></a>  hessian[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span> <span class="fu">t</span>(hessian[<span class="dv">1</span><span class="sc">:</span>p, p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb3-232"><a href="#cb3-232" tabindex="-1"></a>  hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="ot">&lt;-</span> (</span>
<span id="cb3-233"><a href="#cb3-233" tabindex="-1"></a>    <span class="fu">crossprod</span>(psi_coefficient) <span class="sc">+</span> <span class="fu">rowSums</span>(</span>
<span id="cb3-234"><a href="#cb3-234" tabindex="-1"></a>      <span class="fu">sweep</span>(</span>
<span id="cb3-235"><a href="#cb3-235" tabindex="-1"></a>        psi_psi_coefficient,</span>
<span id="cb3-236"><a href="#cb3-236" tabindex="-1"></a>        <span class="dv">3</span>,</span>
<span id="cb3-237"><a href="#cb3-237" tabindex="-1"></a>        variance_term,</span>
<span id="cb3-238"><a href="#cb3-238" tabindex="-1"></a>        <span class="st">`</span><span class="at">*</span><span class="st">`</span></span>
<span id="cb3-239"><a href="#cb3-239" tabindex="-1"></a>      ),</span>
<span id="cb3-240"><a href="#cb3-240" tabindex="-1"></a>      <span class="at">dims =</span> <span class="dv">2</span></span>
<span id="cb3-241"><a href="#cb3-241" tabindex="-1"></a>    )</span>
<span id="cb3-242"><a href="#cb3-242" tabindex="-1"></a>  ) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb3-243"><a href="#cb3-243" tabindex="-1"></a>  hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb3-244"><a href="#cb3-244" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">crossprod</span>(psi_coefficient, variance_term) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb3-245"><a href="#cb3-245" tabindex="-1"></a>  hessian[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, (p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q)] <span class="ot">&lt;-</span></span>
<span id="cb3-246"><a href="#cb3-246" tabindex="-1"></a>    <span class="fu">t</span>(hessian[(p <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(p <span class="sc">+</span> q), p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>])</span>
<span id="cb3-247"><a href="#cb3-247" tabindex="-1"></a>  hessian[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>, p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb3-248"><a href="#cb3-248" tabindex="-1"></a>    <span class="fu">crossprod</span>(variance_term) <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">3</span> <span class="sc">-</span></span>
<span id="cb3-249"><a href="#cb3-249" tabindex="-1"></a>    (<span class="fu">nrow</span>(data) <span class="sc">-</span> q) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">/</span> theta[p <span class="sc">+</span> q <span class="sc">+</span> <span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb3-250"><a href="#cb3-250" tabindex="-1"></a>  hessian</span>
<span id="cb3-251"><a href="#cb3-251" tabindex="-1"></a>}</span>
<span id="cb3-252"><a href="#cb3-252" tabindex="-1"></a></span>
<span id="cb3-253"><a href="#cb3-253" tabindex="-1"></a><span class="co"># fastcpd arma 1 1</span></span>
<span id="cb3-254"><a href="#cb3-254" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb3-255"><a href="#cb3-255" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">600</span></span>
<span id="cb3-256"><a href="#cb3-256" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb3-257"><a href="#cb3-257" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb3-258"><a href="#cb3-258" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">300</span>) {</span>
<span id="cb3-259"><a href="#cb3-259" tabindex="-1"></a>  x[i <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="sc">*</span> x[i] <span class="sc">+</span> w[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> w[i]</span>
<span id="cb3-260"><a href="#cb3-260" tabindex="-1"></a>}</span>
<span id="cb3-261"><a href="#cb3-261" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">301</span><span class="sc">:</span>n) {</span>
<span id="cb3-262"><a href="#cb3-262" tabindex="-1"></a>  x[i <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fl">0.3</span> <span class="sc">*</span> x[i] <span class="sc">+</span> w[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> w[i]</span>
<span id="cb3-263"><a href="#cb3-263" tabindex="-1"></a>}</span>
<span id="cb3-264"><a href="#cb3-264" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">fastcpd</span>(</span>
<span id="cb3-265"><a href="#cb3-265" tabindex="-1"></a>  <span class="at">formula =</span> <span class="sc">~</span> . <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb3-266"><a href="#cb3-266" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x[<span class="dv">1</span> <span class="sc">+</span> <span class="fu">seq_len</span>(n)]),</span>
<span id="cb3-267"><a href="#cb3-267" tabindex="-1"></a>  <span class="at">trim =</span> <span class="dv">0</span>,</span>
<span id="cb3-268"><a href="#cb3-268" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb3-269"><a href="#cb3-269" tabindex="-1"></a>  <span class="at">beta =</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">log</span>(n) <span class="sc">/</span> <span class="dv">2</span>,</span>
<span id="cb3-270"><a href="#cb3-270" tabindex="-1"></a>  <span class="at">cost_adjustment =</span> <span class="st">&quot;BIC&quot;</span>,</span>
<span id="cb3-271"><a href="#cb3-271" tabindex="-1"></a>  <span class="at">cost =</span> qmle,</span>
<span id="cb3-272"><a href="#cb3-272" tabindex="-1"></a>  <span class="at">cost_gradient =</span> qmle_gradient,</span>
<span id="cb3-273"><a href="#cb3-273" tabindex="-1"></a>  <span class="at">cost_hessian =</span> qmle_hessian,</span>
<span id="cb3-274"><a href="#cb3-274" tabindex="-1"></a>  <span class="at">cp_only =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-275"><a href="#cb3-275" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span>), <span class="fl">1e-10</span>),</span>
<span id="cb3-276"><a href="#cb3-276" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span>), <span class="cn">Inf</span>),</span>
<span id="cb3-277"><a href="#cb3-277" tabindex="-1"></a>  <span class="at">line_search =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="fl">1e-2</span>, <span class="fl">1e-3</span>, <span class="fl">1e-4</span>, <span class="fl">1e-5</span>, <span class="fl">1e-6</span>, <span class="fl">1e-7</span>, <span class="fl">1e-8</span>, <span class="fl">1e-9</span>),</span>
<span id="cb3-278"><a href="#cb3-278" tabindex="-1"></a>  <span class="at">r.progress =</span> <span class="cn">FALSE</span></span>
<span id="cb3-279"><a href="#cb3-279" tabindex="-1"></a>)</span>
<span id="cb3-280"><a href="#cb3-280" tabindex="-1"></a><span class="fu">summary</span>(result)</span>
<span id="cb3-281"><a href="#cb3-281" tabindex="-1"></a></span>
<span id="cb3-282"><a href="#cb3-282" tabindex="-1"></a><span class="co"># fastcpd arma 3 2</span></span>
<span id="cb3-283"><a href="#cb3-283" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb3-284"><a href="#cb3-284" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">600</span></span>
<span id="cb3-285"><a href="#cb3-285" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n <span class="sc">+</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb3-286"><a href="#cb3-286" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n <span class="sc">+</span> <span class="dv">3</span>)</span>
<span id="cb3-287"><a href="#cb3-287" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">300</span>) {</span>
<span id="cb3-288"><a href="#cb3-288" tabindex="-1"></a>  x[i <span class="sc">+</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="sc">*</span> x[i <span class="sc">+</span> <span class="dv">2</span>] <span class="sc">-</span> <span class="fl">0.2</span> <span class="sc">*</span> x[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> x[i] <span class="sc">+</span></span>
<span id="cb3-289"><a href="#cb3-289" tabindex="-1"></a>    w[i <span class="sc">+</span> <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> w[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> w[i]</span>
<span id="cb3-290"><a href="#cb3-290" tabindex="-1"></a>}</span>
<span id="cb3-291"><a href="#cb3-291" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">301</span><span class="sc">:</span>n) {</span>
<span id="cb3-292"><a href="#cb3-292" tabindex="-1"></a>  x[i <span class="sc">+</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fl">0.3</span> <span class="sc">*</span> x[i <span class="sc">+</span> <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> x[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> x[i] <span class="sc">+</span></span>
<span id="cb3-293"><a href="#cb3-293" tabindex="-1"></a>    w[i <span class="sc">+</span> <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> w[i <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> w[i]</span>
<span id="cb3-294"><a href="#cb3-294" tabindex="-1"></a>}</span>
<span id="cb3-295"><a href="#cb3-295" tabindex="-1"></a><span class="co"># result &lt;- fastcpd(</span></span>
<span id="cb3-296"><a href="#cb3-296" tabindex="-1"></a><span class="co">#   formula = ~ . - 1,</span></span>
<span id="cb3-297"><a href="#cb3-297" tabindex="-1"></a><span class="co">#   data = data.frame(x = x[3 + seq_len(n)]),</span></span>
<span id="cb3-298"><a href="#cb3-298" tabindex="-1"></a><span class="co">#   trim = 0,</span></span>
<span id="cb3-299"><a href="#cb3-299" tabindex="-1"></a><span class="co">#   p = 3 + 2 + 1,</span></span>
<span id="cb3-300"><a href="#cb3-300" tabindex="-1"></a><span class="co">#   beta = (3 + 2 + 1 + 1) * log(n) / 2,</span></span>
<span id="cb3-301"><a href="#cb3-301" tabindex="-1"></a><span class="co">#   cost_adjustment = &quot;BIC&quot;,</span></span>
<span id="cb3-302"><a href="#cb3-302" tabindex="-1"></a><span class="co">#   cost = function(data, theta) {</span></span>
<span id="cb3-303"><a href="#cb3-303" tabindex="-1"></a><span class="co">#     qmle(data, theta, 3, 2)</span></span>
<span id="cb3-304"><a href="#cb3-304" tabindex="-1"></a><span class="co">#   },</span></span>
<span id="cb3-305"><a href="#cb3-305" tabindex="-1"></a><span class="co">#   cost_gradient = function(data, theta) {</span></span>
<span id="cb3-306"><a href="#cb3-306" tabindex="-1"></a><span class="co">#     qmle_gradient(data, theta, 3, 2)</span></span>
<span id="cb3-307"><a href="#cb3-307" tabindex="-1"></a><span class="co">#   },</span></span>
<span id="cb3-308"><a href="#cb3-308" tabindex="-1"></a><span class="co">#   cost_hessian = function(data, theta) {</span></span>
<span id="cb3-309"><a href="#cb3-309" tabindex="-1"></a><span class="co">#     qmle_hessian(data, theta, 3, 2)</span></span>
<span id="cb3-310"><a href="#cb3-310" tabindex="-1"></a><span class="co">#   },</span></span>
<span id="cb3-311"><a href="#cb3-311" tabindex="-1"></a><span class="co">#   cp_only = TRUE,</span></span>
<span id="cb3-312"><a href="#cb3-312" tabindex="-1"></a><span class="co">#   lower = c(rep(-1, 3 + 2), 1e-10),</span></span>
<span id="cb3-313"><a href="#cb3-313" tabindex="-1"></a><span class="co">#   upper = c(rep(1, 3 + 2), Inf),</span></span>
<span id="cb3-314"><a href="#cb3-314" tabindex="-1"></a><span class="co">#   line_search = c(1, 0.1, 1e-2, 1e-3, 1e-4, 1e-5, 1e-6, 1e-7, 1e-8, 1e-9),</span></span>
<span id="cb3-315"><a href="#cb3-315" tabindex="-1"></a><span class="co">#   r.progress = FALSE</span></span>
<span id="cb3-316"><a href="#cb3-316" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb3-317"><a href="#cb3-317" tabindex="-1"></a><span class="co"># summary(result)</span></span>
<span id="cb3-318"><a href="#cb3-318" tabindex="-1"></a></span>
<span id="cb3-319"><a href="#cb3-319" tabindex="-1"></a><span class="co"># hessian check</span></span>
<span id="cb3-320"><a href="#cb3-320" tabindex="-1"></a>theta_estimate <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fl">0.1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb3-321"><a href="#cb3-321" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">expect_equal</span>(</span>
<span id="cb3-322"><a href="#cb3-322" tabindex="-1"></a>  numDeriv<span class="sc">::</span><span class="fu">hessian</span>(</span>
<span id="cb3-323"><a href="#cb3-323" tabindex="-1"></a>    qmle, theta_estimate, <span class="at">data =</span> <span class="fu">matrix</span>(x[<span class="dv">3</span> <span class="sc">+</span> <span class="fu">seq_len</span>(n)]), <span class="at">p =</span> <span class="dv">3</span>, <span class="at">q =</span> <span class="dv">2</span></span>
<span id="cb3-324"><a href="#cb3-324" tabindex="-1"></a>  ),</span>
<span id="cb3-325"><a href="#cb3-325" tabindex="-1"></a>  <span class="fu">qmle_hessian_sum</span>(<span class="fu">matrix</span>(x[<span class="dv">3</span> <span class="sc">+</span> <span class="fu">seq_len</span>(n)]), theta_estimate, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb3-326"><a href="#cb3-326" tabindex="-1"></a>)</span>
<span id="cb3-327"><a href="#cb3-327" tabindex="-1"></a></span>
<span id="cb3-328"><a href="#cb3-328" tabindex="-1"></a><span class="fu">optim</span>(</span>
<span id="cb3-329"><a href="#cb3-329" tabindex="-1"></a>  <span class="fu">rep</span>(<span class="fl">0.1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb3-330"><a href="#cb3-330" tabindex="-1"></a>  <span class="at">fn =</span> <span class="cf">function</span>(data, theta) {</span>
<span id="cb3-331"><a href="#cb3-331" tabindex="-1"></a>    <span class="fu">qmle</span>(data, theta, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb3-332"><a href="#cb3-332" tabindex="-1"></a>  },</span>
<span id="cb3-333"><a href="#cb3-333" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">matrix</span>(x[<span class="dv">3</span> <span class="sc">+</span> <span class="fu">seq_len</span>(n)]),</span>
<span id="cb3-334"><a href="#cb3-334" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;L-BFGS-B&quot;</span>,</span>
<span id="cb3-335"><a href="#cb3-335" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="fl">1e-10</span>),</span>
<span id="cb3-336"><a href="#cb3-336" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="cn">Inf</span>),</span>
<span id="cb3-337"><a href="#cb3-337" tabindex="-1"></a>  <span class="at">gr =</span> <span class="cf">function</span>(data, theta) {</span>
<span id="cb3-338"><a href="#cb3-338" tabindex="-1"></a>    <span class="fu">qmle_gradient_sum</span>(data, theta, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb3-339"><a href="#cb3-339" tabindex="-1"></a>  }</span>
<span id="cb3-340"><a href="#cb3-340" tabindex="-1"></a>)</span>
<span id="cb3-341"><a href="#cb3-341" tabindex="-1"></a></span>
<span id="cb3-342"><a href="#cb3-342" tabindex="-1"></a><span class="co"># convergence check</span></span>
<span id="cb3-343"><a href="#cb3-343" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">arima.sim</span>(<span class="fu">list</span>(<span class="at">ar =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="sc">-</span><span class="fl">0.2</span>, <span class="fl">0.6</span>), <span class="at">ma =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>)), <span class="at">n =</span> n <span class="sc">+</span> <span class="dv">3</span>)</span>
<span id="cb3-344"><a href="#cb3-344" tabindex="-1"></a>theta_estimate <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fl">0.1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb3-345"><a href="#cb3-345" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">matrix</span>(x[<span class="dv">3</span> <span class="sc">+</span> <span class="fu">seq_len</span>(n)])</span>
<span id="cb3-346"><a href="#cb3-346" tabindex="-1"></a>qmle_path <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-347"><a href="#cb3-347" tabindex="-1"></a>prev_qmle <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-348"><a href="#cb3-348" tabindex="-1"></a>curr_qmle <span class="ot">&lt;-</span> <span class="cn">Inf</span></span>
<span id="cb3-349"><a href="#cb3-349" tabindex="-1"></a>epochs_num <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-350"><a href="#cb3-350" tabindex="-1"></a><span class="cf">while</span> (<span class="fu">abs</span>(curr_qmle <span class="sc">-</span> prev_qmle) <span class="sc">&gt;</span> <span class="fl">1e-5</span>) {</span>
<span id="cb3-351"><a href="#cb3-351" tabindex="-1"></a>  prev_qmle <span class="ot">&lt;-</span> curr_qmle</span>
<span id="cb3-352"><a href="#cb3-352" tabindex="-1"></a>  hessian <span class="ot">&lt;-</span></span>
<span id="cb3-353"><a href="#cb3-353" tabindex="-1"></a>    Matrix<span class="sc">::</span><span class="fu">nearPD</span>(<span class="fu">qmle_hessian_sum</span>(data, theta_estimate, <span class="dv">3</span>, <span class="dv">2</span>))<span class="sc">$</span>mat</span>
<span id="cb3-354"><a href="#cb3-354" tabindex="-1"></a>  step <span class="ot">&lt;-</span> <span class="fu">solve</span>(</span>
<span id="cb3-355"><a href="#cb3-355" tabindex="-1"></a>    hessian, <span class="fu">qmle_gradient_sum</span>(data, theta_estimate, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb3-356"><a href="#cb3-356" tabindex="-1"></a>  )</span>
<span id="cb3-357"><a href="#cb3-357" tabindex="-1"></a>  <span class="co"># line search</span></span>
<span id="cb3-358"><a href="#cb3-358" tabindex="-1"></a>  lr_choices <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="fl">1e-2</span>, <span class="fl">1e-3</span>, <span class="fl">1e-4</span>, <span class="fl">1e-5</span>, <span class="fl">1e-6</span>, <span class="fl">1e-7</span>, <span class="fl">1e-8</span>, <span class="fl">1e-9</span>)</span>
<span id="cb3-359"><a href="#cb3-359" tabindex="-1"></a>  lr <span class="ot">&lt;-</span> lr_choices[<span class="fu">which.min</span>(</span>
<span id="cb3-360"><a href="#cb3-360" tabindex="-1"></a>    <span class="fu">sapply</span>(lr_choices, <span class="cf">function</span>(lr) {</span>
<span id="cb3-361"><a href="#cb3-361" tabindex="-1"></a>      <span class="fu">qmle</span>(data, <span class="fu">pmin</span>(</span>
<span id="cb3-362"><a href="#cb3-362" tabindex="-1"></a>        <span class="fu">pmax</span>(theta_estimate <span class="sc">-</span> lr <span class="sc">*</span> step, <span class="fu">c</span>(<span class="fu">rep</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="fl">1e-10</span>)),</span>
<span id="cb3-363"><a href="#cb3-363" tabindex="-1"></a>        <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="cn">Inf</span>)</span>
<span id="cb3-364"><a href="#cb3-364" tabindex="-1"></a>      ), <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb3-365"><a href="#cb3-365" tabindex="-1"></a>    })</span>
<span id="cb3-366"><a href="#cb3-366" tabindex="-1"></a>  )]</span>
<span id="cb3-367"><a href="#cb3-367" tabindex="-1"></a>  theta_estimate <span class="ot">&lt;-</span> <span class="fu">pmin</span>(</span>
<span id="cb3-368"><a href="#cb3-368" tabindex="-1"></a>    <span class="fu">pmax</span>(theta_estimate <span class="sc">-</span> lr <span class="sc">*</span> step, <span class="fu">c</span>(<span class="fu">rep</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="fl">1e-10</span>)),</span>
<span id="cb3-369"><a href="#cb3-369" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">3</span> <span class="sc">+</span> <span class="dv">2</span>), <span class="cn">Inf</span>)</span>
<span id="cb3-370"><a href="#cb3-370" tabindex="-1"></a>  )</span>
<span id="cb3-371"><a href="#cb3-371" tabindex="-1"></a>  curr_qmle <span class="ot">&lt;-</span> <span class="fu">qmle</span>(data, theta_estimate, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb3-372"><a href="#cb3-372" tabindex="-1"></a>  <span class="fu">cat</span>(epochs_num, curr_qmle, theta_estimate, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb3-373"><a href="#cb3-373" tabindex="-1"></a>  qmle_path <span class="ot">&lt;-</span> <span class="fu">c</span>(qmle_path, curr_qmle)</span>
<span id="cb3-374"><a href="#cb3-374" tabindex="-1"></a>  epochs_num <span class="ot">&lt;-</span> epochs_num <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb3-375"><a href="#cb3-375" tabindex="-1"></a>}</span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
